{% extends 'userpages/index.html' %}
{% load static %}

{% block title %}Chi tiết: {{ baucu.title }}{% endblock %}

{% block content %}
<div class="pc-container">
    <div class="pc-content">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">{{ baucu.title }}</h3>
                    {% if is_voter %}
                    <a href="{% url 'my_vote' baucu.id %}" class="btn btn-info">
                        <i class="ti ti-eye"></i> Xem phiếu của tôi
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h4>Thông tin chung</h4>
                        <p>{{ baucu.description }}</p>
                    </div>
                    <div class="col-md-4">
                        <h4>Thời gian</h4>
                        <p><strong>Bắt đầu:</strong> {{ baucu.start_date|date:"H:i, d/m/Y" }}</p>
                        <p><strong>Kết thúc:</strong> {{ baucu.end_date|date:"H:i, d/m/Y" }}</p>
                        <p><strong>Được bầu tối đa:</strong> {{ baucu.max_choices }} người</p>
                    </div>
                </div>
                <hr>

                {% if messages %}
                    <div class="mb-3">
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- =============================================================== -->
                <!-- ================ LOGIC HIỂN THỊ CHÍNH ========================= -->
                <!-- =============================================================== -->

                {% if not request.user.is_authenticated %}
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="ti ti-user-x f-48 mb-3"></i>
                        <h4 class="alert-heading">Chưa đăng nhập!</h4>
                        <p>Vui lòng <a href="{% url 'login' %}" class="alert-link">đăng nhập</a> để tham gia.</p>
                    </div>
                {% elif not is_voter %}
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="ti ti-key f-48 mb-3"></i>
                        <h4 class="alert-heading">Chưa phải là Cử tri!</h4>
                        <p>Tài khoản của bạn chưa được đăng ký làm cử tri. Vui lòng <a href="{% url 'view_dangky_cutri' %}" class="alert-link">đăng ký</a> để có thể tham gia.</p>
                    </div>

                {% elif is_ended %}
                    {# --- HIỂN THỊ KẾT QUẢ HOẶC THÔNG BÁO CHỜ --- #}
                    {% if winners %}
                        <div class="text-center border-primary shadow-sm py-4 rounded">
                            <i class="ti ti-trophy text-warning" style="font-size: 4rem;"></i>
                            <h4 class="alert-heading mt-2">CUỘC BẦU CỬ ĐÃ KẾT THÚC!</h4>
                            
                            <!-- CÔNG BỐ NGƯỜI THẮNG CUỘC -->
                            {% if winners|length > 1 %}
                                <p class="lead">Kết quả hòa giữa các ứng viên:</p>
                                {% for winner in winners %}
                                    <h3 class="fw-bold d-inline-block me-3">{{ winner.name }}</h3>
                                {% endfor %}
                            {% else %}
                                {% with winner=winners.0 %}
                                <p class="lead">Người thắng cuộc là:</p>
                                {% if winner.avatar %}
                                    <img src="{{ winner.avatar.url }}" class="rounded-circle my-3 shadow" alt="{{ winner.name }}" width="120" height="120" style="object-fit: cover;">
                                {% endif %}
                                <h2 class="fw-bold text-primary">{{ winner.name }}</h2>
                                {% endwith %}
                            {% endif %}
                            <hr>
                            
                            <!-- BẢNG KẾT QUẢ CHI TIẾT -->
                            <p class="lead">Kết quả chi tiết:</p>
                            <div class="table-responsive px-3">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Hạng</th>
                                            <th>Ứng cử viên</th>
                                            <th class="text-end">Số phiếu</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in election_results %}
                                        <tr>
                                            <td><strong>{{ forloop.counter }}</strong></td>
                                            <td>{{ item.name }}</td>
                                            <td class="text-end">{{ item.count }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% elif is_pending_tally %}
                        <div class="alert alert-info text-center" role="alert">
                            <i class="ti ti-hourglass-empty f-48 mb-3"></i>
                            <h4 class="alert-heading">Đang chờ kiểm phiếu</h4>
                            <p>Cuộc bầu cử đã kết thúc. Kết quả đang được Hội đồng Kiểm phiếu xử lý và sẽ được công bố sớm. Vui lòng quay lại sau.</p>
                        </div>
                    {% else %}
                        <div class="alert alert-secondary text-center" role="alert">
                            <i class="ti ti-info-circle f-48 mb-3"></i>
                            <h4 class="alert-heading">Cuộc bầu cử đã kết thúc</h4>
                            <p>Không có phiếu bầu nào được ghi nhận trong cuộc bầu cử này.</p>
                        </div>
                    {% endif %}

                {% elif has_voted %}
                    <div class="alert alert-success text-center" role="alert">
                        <i class="ti ti-circle-check f-48 mb-3"></i>
                        <h4 class="alert-heading">Bạn đã bỏ phiếu!</h4>
                        <p>Cảm ơn bạn đã tham gia. Phiếu bầu của bạn đã được ghi nhận an toàn và mã hóa.</p>
                    </div>
                {% elif not is_active %}
                    <div class="alert alert-info text-center" role="alert">
                        <i class="ti ti-clock-off f-48 mb-3"></i>
                        <h4 class="alert-heading">Cuộc bầu cử chưa diễn ra.</h4>
                        <p>Vui lòng quay lại trong khoảng thời gian bỏ phiếu đã được thông báo.</p>
                    </div>
                {% else %}
                    <!-- FORM BỎ PHIẾU -->
                    <h4>Danh sách ứng cử viên</h4>
                    <form method="POST" action="{% url 'bo_phieu' baucu.id %}" id="voteForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row g-3">
                            {% for ungcuvien in ungcuviens %}
                            <div class="col-md-6">
                                <label class="list-group-item d-flex align-items-center h-100" for="uc{{ ungcuvien.id }}">
                                    <div class="me-3">
                                        {% if ungcuvien.avatar %}
                                            <img src="{{ ungcuvien.avatar.url }}" class="rounded-circle" alt="{{ ungcuvien.name }}" width="60" height="60" style="object-fit: cover;">
                                        {% else %}
                                            <img src="{% static 'images/user/avatar-8.jpg' %}" class="rounded-circle" alt="Default Avatar" width="60" height="60">
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">{{ ungcuvien.name }}</h6>
                                    </div>
                                    <div class="ms-auto">
                                        <input type="checkbox" class="form-check-input" name="candidates" id="uc{{ ungcuvien.id }}" value="{{ ungcuvien.id }}">
                                    </div>
                                </label>
                            </div>
                            {% empty %}
                                <p class="text-muted">Chưa có ứng cử viên nào.</p>
                            {% endfor %}
                        </div>

                        {% if ungcuviens %} 
                            <h5 class="mt-4 mb-3">Cung cấp khóa bí mật của bạn:</h5>
                            <div class="mb-3">
                                <label for="keyFile" class="form-label">Tải lên file khóa (.key)</label>
                                <input type="file" class="form-control" id="keyFile" name="key_file" accept=".key,.json" required>
                                <div class="form-text">Đây là file bạn đã tải xuống khi đăng ký cử tri.</div>
                            </div>
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary" id="submitVoteButton" onclick="return confirm('Bạn có chắc chắn muốn bỏ phiếu không? Hành động này không thể thay đổi.')">
                                    <i class="ti ti-hand-click"></i> Xác nhận bỏ phiếu
                                </button>
                            </div>
                        {% endif %}
                    </form>
                {% endif %}

                <div class="mt-4">
                    <a href="{% url 'baucu_u' %}" class="btn btn-secondary">
                        <i class="ti ti-arrow-left"></i> Quay lại
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
