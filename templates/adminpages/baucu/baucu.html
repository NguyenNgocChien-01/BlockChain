{% extends 'adminpages/index.html' %}
{% load static %}

{% block content %}
  <div class="pc-container">
    <div class="pc-content">
        <div class="row">
            <div class="col-xl-3 col-md-6">
                <div class="card shadow">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="ti ti-ballot f-36"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">Tổng số</h6>
                                <h5 class="mb-0">{{ total_ballots }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card shadow">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="ti ti-player-play f-36"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">Đang diễn ra</h6>
                                <h5 class="mb-0">{{ ongoing_ballots }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                 <div class="card shadow ">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="ti ti-calendar-time f-36"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">Sắp diễn ra</h6>
                                <h5 class="mb-0">{{ upcoming_ballots }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                 <div class="card shadow">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="ti ti-circle-check f-36"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-0">Đã kết thúc</h6>
                                <h5 class="mb-0">{{ ended_ballots }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      <div class="card-body">


        <div class="card">
            <div class="card-header">
                <h3>Danh sách Bầu cử</h3>
            </div>
            <div class="card-body">
                <!-- THANH ĐIỀU KHIỂN: LỌC VÀ TÌM KIẾM -->
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                    
                    <!-- Nhóm các bộ lọc và tìm kiếm bên trái -->
                    <form method="get" action="{% url 'baucu' %}" class="d-flex flex-wrap gap-2 align-items-center">
                        
                        <!-- Bộ lọc theo Trạng thái -->
                        <select name="status_filter" class="form-select form-select-sm" onchange="this.form.submit()" style="width: auto;">
                            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Tất cả Trạng thái</option>
                            <option value="ongoing" {% if status_filter == 'ongoing' %}selected{% endif %}>Đang diễn ra</option>
                            <option value="upcoming" {% if status_filter == 'upcoming' %}selected{% endif %}>Sắp diễn ra</option>
                            <option value="ended" {% if status_filter == 'ended' %}selected{% endif %}>Đã kết thúc</option>
                        </select>

                        <!-- Bộ lọc theo Chế độ -->
                        <select name="type_filter" class="form-select form-select-sm" onchange="this.form.submit()" style="width: auto;">
                            <option value="all" {% if type_filter == 'all' %}selected{% endif %}>Tất cả Chế độ</option>
                            <option value="public" {% if type_filter == 'public' %}selected{% endif %}>Công khai</option>
                            <option value="private" {% if type_filter == 'private' %}selected{% endif %}>Riêng tư</option>
                        </select>

                        <!-- Thanh tìm kiếm -->
                        <div class="input-group input-group-sm" style="width: auto;">
                            <input name="keyword" class="form-control" placeholder="Tìm theo tiêu đề..." type="search" value="{{ keyword|default:'' }}">
                            <button type="submit" class="btn btn-primary"><i class="ti ti-search"></i></button>
                        </div>
                    </form>

                    <!-- Nút Thêm Mới bên phải -->
                    <div class="ms-auto">
                        <a href="#" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addbaucuModal">
                            <i class="ti ti-plus f-18"></i> Tạo Mới
                        </a>
                    </div>
                </div>

            <div class="datatable-container">
              <table class="table table-hover datatable-table" id="pc-dt-simple">
                <thead>
                  <tr>
                    <th style="width: 2%;"></th>
                    <th style="width: 10%;">Tên</th>
                    <th style="width: 8%;">Mô tả</th>
                    {% comment %} <th style="width: 8%;">Thời gian bắt đầu</th>
                    <th style="width: 8%;">Thời gian kết thúc</th> {% endcomment %}
                    
                    <th style="width: 8%;">Trạng thái</th>
                    <th style="width: 8%;">Loại hình</th>
                    <th style="width: 8.88888888888889%;">Thao tác</th>

                  </tr>
                </thead>
                <tbody>
                  {% if baucus %}
                    {% for baucu in baucus %}
                      <tr data-index="0">
                        <td>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox">
                          </div>
                        </td>
                        <td>
                          <div class="row">
                            <div class="col-auto pe-0"></div>
                            <div class="col">
                              <h6 class="mb-1">{{ baucu.title }}</h6>
                              <p class="text-muted f-12 mb-0"></p>
                            </div>
                          </div>
                        </td>
                        <td><p class="text-muted f-12 mb-0">{{ baucu.description }}</p></td>
                        {% comment %} <td><p class="text-muted f-12 mb-0">{{ baucu.start_date|date:'Y-m-d H:i' }}</p></td>
                        <td><p class="text-muted f-12 mb-0">{{ baucu.end_date|date:'Y-m-d H:i' }}</p></td> {% endcomment %}
                        <td>
                            {% if now > baucu.end_date %}
                                <a href="{% url 'chitiet_baucu' baucu.id %}"><span class="badge bg-secondary">Đã kết thúc</span></a>
                            {% elif now < baucu.start_date %}
                                <a  href="{% url 'chitiet_baucu' baucu.id %}"><span class="badge bg-info">Chưa diễn ra</span></a>
                            {% else %}
                                <a href="{% url 'chitiet_baucu' baucu.id %}"><span class="badge bg-success">Đang diễn ra</span></a>
                            {% endif %}
                          <td>{{baucu.type}}</td>
                        <td>
                          <ul class="list-inline me-auto mb-0">
                            <li class="list-inline-item align-bottom" data-bs-toggle="tooltip" aria-label="Kết quả">
                              <a href="{% url 'ketqua_baucu' baucu.id %}" class="avtar avtar-xs btn-link-success">
                                <i class="ti ti-chart-bar f-18"></i>
                              </a>
                            </li>
                            <li class="list-inline-item align-bottom" data-bs-toggle="tooltip" aria-label="Edit">
                                        <a href="#" class="avtar avtar-xs btn-link-primary edit-bau-cu-btn"
                                           data-bs-toggle="modal"
                                           data-bs-target="#editbaucuModal"
                                           data-id="{{ baucu.id }}"
                                           data-tieude="{{ baucu.title }}"
                                           data-mota="{{ baucu.description }}"
                                           data-tgbd="{{ baucu.start_date|date:'Y-m-d\TH:i' }}"
                                           data-tgkt="{{ baucu.end_date|date:'Y-m-d\TH:i' }}"
                                           data-type="{{ baucu.type }}"
                                           data-max="{{baucu.max_choices}}"
                                           data-voters="{% for voter in baucu.eligible_voters.all %}{{ voter.id }},{% endfor %}">
                                
                                <i class="ti ti-edit-circle f-18"></i>
                              </a>
                            </li>
                            <li class="list-inline-item align-bottom  " data-bs-toggle="tooltip" aria-label="Delete">
                               {% comment %} <a href="{% url 'delete_baucu' baucu.id %}" class="avtar avtar-xs btn-link-danger delete" >
                                <i class="ti ti-trash f-18"></i>
                              </a> {% endcomment %}
                            </li>
                            <li class="list-inline-item align-bottom" data-bs-toggle="tooltip" aria-label="Đào khối thủ công">
                                {% comment %} <a href="{% url 'dao_block' baucu.id %}" 
                                   class="avtar avtar-xs btn-link-warning" 
                                   onclick="return confirm('Bạn có chắc chắn muốn ép đào khối cho cuộc bầu cử này không? Hành động này sẽ gom tất cả các phiếu đang chờ vào một khối mới ngay lập tức.')">
                                    <span class="badge bg-secondary"><br>Lưu phiếu<br><br> </span>
                                </a>
                            </li> {% endcomment %}
                          </ul>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                  <p class="no-data-message">Chưa có bầu cử nào để hiển thị.</p>
                  {% endif %}
                </tbody>
              </table>
            </div>
            <div class="datatable-bottom"></div>
          </div>
        </div>
      </div>

      <!-- Modal Thêm  -->
      <div class="modal fade" id="addbaucuModal" tabindex="-1" aria-labelledby="addbaucuModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addbaucuModalLabel">Tạo bầu cử mới</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              {% include 'adminpages/baucu/add_baucu.html' %}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button type="submit" form="addbaucuForm" class="btn btn-primary">Thêm</button>
            </div>
          </div>
        </div>
      </div>
       <!-- Modal Sửa Địa Điểm -->
      <div class="modal fade" id="editbaucuModal" tabindex="-1" aria-labelledby="editbaucuModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id=editdbaucuModalLabel">Sửa Thông Tin</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              {% include 'adminpages/baucu/edit_baucu.html'  %}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button type="submit" form="editbaucuForm" class="btn btn-primary">Sửa</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const editButtons = document.querySelectorAll('.edit-bau-cu-btn');
    const editForm = document.getElementById('editbaucuForm');
    
    // Lấy tất cả các phần tử của form 
    const editTitleInput = editForm.querySelector('#edit_id_tieude');
    const editStartDateInput = editForm.querySelector('#edit_id_start_date');
    const editEndDateInput = editForm.querySelector('#edit_id_end_date');
    const editDescriptionInput = editForm.querySelector('#edit_id_mota');
    const editPublicRadio = editForm.querySelector('#edit_type_public');
    const editPrivateRadio = editForm.querySelector('#edit_type_private');
    const editMaxChoicesInput = editForm.querySelector('#edit_id_max_choices');
    const editVotersWrapper = editForm.querySelector('#edit_eligible_voters_wrapper');
    const editVotersSelect = editForm.querySelector('#edit_id_eligible_voters');

    // Hàm để ẩn/hiện danh sách cử tri 
    function toggleVotersListEdit() {
        if (editPrivateRadio.checked) {
            editVotersWrapper.style.display = 'block';
        } else {
            editVotersWrapper.style.display = 'none';
        }
    }

    // Gán sự kiện cho các nút radio
    editPublicRadio.addEventListener('change', toggleVotersListEdit);
    editPrivateRadio.addEventListener('change', toggleVotersListEdit);

    editButtons.forEach(button => {
        button.addEventListener('click', () => {
            //  Lấy tất cả dữ liệu từ các thuộc tính data
            const id = button.dataset.id;
            const tieude = button.dataset.tieude;
            const tgbd = button.dataset.tgbd;
            const tgkt = button.dataset.tgkt;
            const mota = button.dataset.mota;
            const type = button.dataset.type;
            const voterIdsString = button.dataset.voters;
            const max = button.dataset.max;

            editForm.action = `edit/${id}/`; 
            editTitleInput.value = tieude;
            editStartDateInput.value = tgbd;
            editEndDateInput.value = tgkt;
            editDescriptionInput.value = mota;
            editMaxChoicesInput.value = max;

            //  Chọn đúng nút radio 
            if (type === 'PRIVATE') {
                editPrivateRadio.checked = true;
            } else {
                editPublicRadio.checked = true;
            }

            //  Chọn trước các cử tri đã được gán
            // Đầu tiên, bỏ chọn tất cả
            for (let i = 0; i < editVotersSelect.options.length; i++) {
                editVotersSelect.options[i].selected = false;
            }

            // Tạo một mảng chứa ID của các cử tri được chọn
            const selectedVoterIds = voterIdsString.split(',').filter(id => id); // filter(id => id) để loại bỏ chuỗi rỗng

            // Lặp qua các lựa chọn và chọn những cái đúng
            for (let i = 0; i < editVotersSelect.options.length; i++) {
                if (selectedVoterIds.includes(editVotersSelect.options[i].value)) {
                    editVotersSelect.options[i].selected = true;
                }
            }

            // Hiển thị hoặc ẩn danh sách cử tri dựa trên loại hình
            toggleVotersListEdit();
        });
    });
});
</script>

{% endblock %}


